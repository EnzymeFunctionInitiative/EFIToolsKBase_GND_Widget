<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">   
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta name="description" content="">
        <meta name="author" content="">

        <title>(TEST) Genome Neighborhood Diagrams {{ window_title }}</title>

        <!-- Bootstrap core CSS -->
        <link href="{{ widget_asset_url }}/css/bootstrap.min.css" rel="stylesheet">
        <link href="{{ widget_asset_url }}/css/menu-sidebar.css" rel="stylesheet">
        <link href="{{ widget_asset_url }}/css/all.min.css" rel="stylesheet">


        <!-- Custom styles for this template -->
        <link href="{{ widget_asset_url }}/css/diagrams.css?v=20" rel="stylesheet">
        <link href="{{ widget_asset_url }}/css/alert.css" rel="stylesheet">
<!--
        <script src="js/app.js" type="application/javascript"></script>
        <script src="js/arrows.js" type="application/javascript"></script>
-->
        <style>
            #header-logo { float: left; width: 175px; }
            #header-body { margin-left: 185px; overflow: hidden; height: 70px; }
            #header-body-title  { vertical-align: middle; line-height: normal; padding-left: 15px; }
            /*#header-body-title  { float: left; width: calc(100%-200px); display: inline-block; vertical-align: middle; line-height: normal; width: calc(100%-370px); }*/
            #header-job-info { width: 195px; }
            #header-job-info div { line-height: normal; }
            @font-face {
                font-family:'FontAwesome';
                src:url("https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/webfonts/fa-solid-900.ttf") format("truetype");
            }
        </style>

        <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
            <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->
    </head>

    <body>
        {% include 'partials/header.html' %}

        <!-- Begin page content -->
        <div id="wrapper" class="">
            <div id="sidebar-wrapper">
                <ul class="sidebar-nav">
                    <li id="advanced-search-panel" style="background-color: red;">
                        {% include 'partials/search-input.html' %}
                    </li>
                    <li style="background-color: green;">
                        {% include 'partials/filter-input.html' %}
                    </li>
                    <li>
                                                <div id="window-tools" class="initial-hidden">
                            <i class="fas fa-window-maximize" aria-hidden="true"></i> <span class="sidebar-header">Genome Window</span>
                            <div>
                                <select id="window-size" class="light zoom-btn">
                                    {% for i in range(1, max_nb_size + 1) %}
                                        <option value="{{ i }}" {% if nb_size == i %}selected{% endif %}>{{ i }}</option>
                                    {% endfor %}
                                </select> genes
                                <button type="button" class="btn btn-default tool-button auto zoom-btn" id="refresh-window">
                                    <i class="fas fa-refresh" aria-hidden="true"></i> Apply
                                </button>
                            </div>
                            <div>
                                <button type="button" class="btn btn-default tool-button zoom-btn" id="scale-zoom-out-large" style="font-size: 1.2em" title="0.25x">
                                    <i class="fas fa-search-minus"></i>
                                </button>
                                <button type="button" class="btn btn-default tool-button zoom-btn" id="scale-zoom-out-small" title="0.888x">
                                    <i class="fas fa-search-minus"></i>
                                </button>
                                Zoom
                                <button type="button" class="btn btn-default tool-button zoom-btn" id="scale-zoom-in-small" title="1.125x">
                                    <i class="fas fa-search-plus" title="1.125x"></i>
                                </button>
                                <button type="button" class="btn btn-default tool-button zoom-btn" id="scale-zoom-in-large" style="font-size: 1.2em" title="4x">
                                    <i class="fas fa-search-plus"></i>
                                </button>
                                <!--Scale factor: 1000 AA=<input type="text" width="5" name="scale-factor" id="scale-factor" value="15" style="line-height: 1.5em; padding: 2px; width: 35px; color: black" title="press enter to apply" />%-->
                            </div>
                        </div>
                    </li>
                    <li>
                                                <div id="page-tools" class="initial-hidden">
                            <i class="fas fa-wrench" aria-hidden="true"></i> <span class="sidebar-header">Tools</span>
                            <div class="btn-group" style="width: 100%; margin-button: 30px">
                                <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                                    Export Data <span class="caret"></span>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a href="#" id="export-gene-graphics-button"><i class="far fa-image" aria-hidden="true"></i> Export to Gene Graphics</a></li>
                                    {% if is_example == "false" and supports_download == "true" and is_uploaded_diagram == "false" %}
                                        <li><a id="download-data" href="download_files.php?direct-id=30093&key=52eb593c2fed778dcfd6a2cf16d1f5ced3f3f617&type=data-file"
                                            title="Download the data to upload it for future analysis using this tool.">
                                            <i class="fas fa-download" aria-hidden="true"></i> Download Data as SQLite
                                        </a></li>
                                    {% endif %}
                                </ul>
                            </div>

                            <div>
                                <button type="button" class="btn btn-default tool-button" id="save-canvas-button">
                                    <i class="far fa-image" aria-hidden="true"></i> Save as SVG
                                </button>
                            </div>
                            <div>
                                <a href="" target="_blank">
                                    <button type="button" class="btn btn-default tool-button">
                                        <i class="fas fa-window-restore" aria-hidden="true"></i> New Window
                                    </button>
                                </a>
                            </div>
                            {% if is_direct_job == "true" %}
                                <div>
                                    <button type="button" class="btn btn-default tool-button" id="show-uniprot-ids">
                                        <i class="far fa-thumbs-up" aria-hidden="true"></i> {% if is_blast == "false" %}Recognized {% endif %}UniProt IDs                                    
                                    </button>
                                </div>
                            {% endif %}
                            {% if has_unmatched_ids == "true" %}
                                <div>
                                    <button type="button" class="btn btn-default tool-button" id="show-unmatched-ids">
                                        <i class="fas fa-thumbs-down" aria-hidden="true"></i> Unmatched IDs
                                    </button>
                                </div>
                            {% endif %}
                            {% if is_blast == "true" %}
                                <div>
                                    <button type="button" class="btn btn-default tool-button" id="show-blast-sequence">
                                    <i class="fas fa-file-alt" aria-hidden="true"></i> Input Sequence
                                    </button>
                                </div>
                            {% endif %}

                            <div>
                                <a href="https://efi.igb.illinois.edu//efi-gnt/diagram_tutorial.pdf">
                                <button type="button" class="btn btn-default tool-button" id="show-blast-sequence">
                                <i class="fas fa-file-alt" aria-hidden="true"></i> Tutorial
                                </button>
                                </a>
                            </div>
                            <div>
                                <button type="button" class="btn btn-default tool-button" id="help-modal-button"><i class="fas fa-question"></i> Quick Tips</button>
                            </div>
                            <div>
                                <button type="button" class="btn btn-default tool-button" id="info-modal-button"><i class="fas fa-info"></i> Licenses</button>
                            </div>
                        </div>

                    </li>
                </ul>
            </div>

            <div class="container">
                <div id="arrow-container" style="width:100%;height:100%">
                    <br>
                    <svg id="arrow-canvas" width="100%" style="height:70px" viewBox="0 0 10 70" preserveAspectRatio="xMinYMin"></svg>

                    <!-- Progess loading bar at bottom of page -->
                    <div style="margin-top:50px;width:100%;position:fixed;bottom:0;height:50px;margin-bottom:100px">
                        <i id="progress-loader" class="fas fa-sync black fa-spin fa-4x fa-fw hidden-placeholder"></i>
                        <i id="progress-error" class="fas fa-exclamation-circle black fa-4x fa-fw hidden-placeholder"></i>
                        <span id="loader-message"></span><br>
                        <div class="progress hidden">
                            <div class="progress-bar" style="width: 10%" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" id="progress-bar"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer class="footer">
            <table style="width:100%;height:60px">
                <tr>
                    <td style="width: 275px;">
                        <img src="{{ widget_asset_url }}/img/efi_logo45.png" width="150" height="45" alt="EFI Logo" style="margin-left:45px" />
                    </td>
                                        <td>
                        <div class="initial-hidden">
                            <div>
                                Showing <span id="diagrams-displayed-count">0</span> of <span id="diagrams-total-count">0</span> diagrams.
                            </div>
                            <div id="diagram-filter-count-container" style="display: none"> 
                                Number of Diagrams with Selected Families: <span>0</div>
                            </div>
                        </div>
                    </td>
                    <td style="width:250px">
                        <button type="button" class="btn btn-default" id="show-all-arrows-button">Show All</button>
                        <button type="button" class="btn btn-default" id="show-more-arrows-button">Show 200 More</button>
                    </td>
                </tr>
            </table>
        </footer>

        <div id="alert-msg">Unable to show requested diagrams.</div> 


        <!-- Bootstrap core JavaScript
        ================================================== -->
        <!-- Placed at the end of the document so the pages load faster -->

        <script src="{{ widget_asset_url }}/js/snap.svg-min.js" content-type="text/javascript"></script>

        <!-- jQuery -->
        <script src="{{ widget_asset_url }}/js/jquery.min.js"></script>
        <!-- Bootstrap Core JavaScript -->
        <script src="{{ widget_asset_url }}/js/bootstrap.min.js"></script>

        <script src="{{ widget_asset_url }}/js/color.js?v=20" content-type="text/javascript"></script>
        <script src="{{ widget_asset_url }}/js/control.js?v=20" content-type="text/javascript"></script>
        <script src="{{ widget_asset_url }}/js/data.js?v=20" content-type="text/javascript"></script>
        <script src="{{ widget_asset_url }}/js/filter.js?v=20" content-type="text/javascript"></script>
        <script src="{{ widget_asset_url }}/js/http.js?v=20" content-type="text/javascript"></script>
        <script src="{{ widget_asset_url }}/js/message.js?v=20" content-type="text/javascript"></script>
        <script src="{{ widget_asset_url }}/js/popup.js?v=20" content-type="text/javascript"></script>
        <script src="{{ widget_asset_url }}/js/ui.js?v=20" content-type="text/javascript"></script>
        <script src="{{ widget_asset_url }}/js/vars.js?v=20" content-type="text/javascript"></script>
        <script src="{{ widget_asset_url }}/js/view.js?v=20" content-type="text/javascript"></script>
        <script src="{{ widget_asset_url }}/js/ui-filter.js?v=20" content-type="text/javascript"></script>
        <script src="{{ widget_asset_url }}/js/app-specific.js?v=20" content-type="text/javascript"></script>
        <script src="{{ widget_asset_url }}/js/svg-util.js?v=20" content-type="text/javascript"></script>
        <script src="{{ widget_asset_url }}/js/uniref.js?v=20" content-type="text/javascript"></script>
        <script src="{{ widget_asset_url }}/js/bigscape.js?v=20" content-type="text/javascript"></script>
        <script type="application/javascript">
            $(document).ready(function() {
                $("#filter-cb-toggle").prop("checked", false);
                $("#filter-anno-toggle").prop("checked", false);
                $("#filter-anno-toggle").addClass("disabled");
                //$("#advanced-search-use-uniref").prop("checked", false);
                $("#window-size").val("{{ nb_size }}");
                if (checkBrowserSupport()) {

                    var svgCanvasId = "#arrow-canvas";
                    var pfamFilterContainerId = "#filter-container-pfam";
                    var interproFilterContainerId = "#filter-container-interpro";
                    var legendContainerId = "#active-filter-list";
                    var numDiagramsFilteredId = "#diagram-filter-count-container";
                    var superfamilySupport = {{ is_superfamily_job }};
                    var uniRefUiIds = {};
                    var query = 1;
                    var windowSize = "{{ nb_size }}";
                    var idKeyQueryString = "{{ id_key_query_string }}";
                    var idTypeButtonClicked = false;
                    diagramsDisplayed = 0;
                    
                    uniRefUiIds.uniref50Cb = "uniref50-cb";
                    uniRefUiIds.uniref50Btn = "uniref50-btn";
                    uniRefUiIds.uniprotCb = "uniprot-cb";
                    uniRefUiIds.uniprotBtn = "uniprot-btn";
                    uniRefUiIds.uniref90Cb = "uniref90-cb";
                    uniRefUiIds.uniref90Btn = "uniref90-btn";
                    uniRefUiIds.uniRefTitleId = "cluster-uniref-id";

                    // Create objects
                    var gndVars = new GndVars();
                    // Initialize constant vars
                    gndVars.setPageSize(200);
                    gndVars.setUrlPath("{{ widget_asset_url.split('widgets/')[0] + 'widgets/data' }}");
                    gndVars.setAuthString("{{ id_key_query_string }}");
                    gndVars.setWindow("{{ nb_size }}");
                    if (superfamilySupport)
                        gndVars.setSuperfamilySupport(true);

                    var gndColor = new GndColor();
                    var gndRouter = new GndMessageRouter();
                    var gndHttp = new GndHttp(gndRouter);
                    var popupIds = new GndInfoPopupIds();
                    var bigscape = new BigScape("{{ gnn_id }}", "{{ gnn_key }}", "", "");
                    var uniRefSupport = new UniRef(false, "");
                    
                    var gndDb = new GndDb(gndColor);
                    var gndFilter = new GndFilter(gndRouter, gndDb);
                    var gndPopup = new GndInfoPopup(gndRouter, gndDb, popupIds);
                    var gndView = new GndView(gndRouter, gndDb, gndFilter, gndPopup, svgCanvasId, uniRefSupport);

                    var control = new GndController(gndRouter, gndDb, gndHttp, gndVars, gndView, gndFilter, bigscape, uniRefSupport);
                    var filterUi = new GndFilterUi(gndRouter, gndFilter, gndColor, pfamFilterContainerId, interproFilterContainerId, legendContainerId, numDiagramsFilteredId);
                    var ui = new GndUi(gndRouter, control, filterUi, gndVars, uniRefSupport);

                    // Add callbacks
                    //gndRouter.addListener(uiFilterUpdate); //TODO

                    // Register hooks to UI
                    ui.registerZoom("#scale-zoom-out-large", "#scale-zoom-out-small", "#scale-zoom-in-small", "#scale-zoom-in-large");
                    ui.registerShowMoreBtn("#show-more-arrows-button");
                    ui.registerShowAllBtn("#show-all-arrows-button");
                    ui.registerWindowUpdateBtn("#refresh-window", "#window-size");
                    ui.registerProgressLoader("#progress-loader");
                    ui.registerErrorLoader("#progress-error");
                    ui.registerFilterControl("#filter-cb-toggle");
                    ui.registerFilterClear("#filter-clear");
                    ui.registerFilterAnnotation("#filter-anno-toggle", "#filter-anno-toggle-text");
                    ui.registerFilterFamilyGroup("#filter-accordion-panel-pfam", "#filter-accordion-panel-interpro", "#filter-search");
                    ui.registerDiagramCountField("#diagrams-displayed-count", "#diagrams-total-count");
                    ui.registerLoaderMessage("#loader-message");
                    ui.registerProgressBar("#progress-bar");
                    ui.registerSearchBtn("#advanced-search-cluster-button", "#advanced-search-input", "#start-info", "#advanced-search-panel");
                    ui.registerUniRefControl("#advanced-search-use-uniref-container", "display-id-type", uniRefUiIds);
                    if ({{ is_direct_job }} || {{ is_realtime_job }}) {
                        ui.registerSearchResetToInitialBtn("#advanced-search-reset-button", "#advanced-search-input");
                    } else {
                        ui.registerSearchClearBtn("#advanced-search-reset-button", "#advanced-search-input");
                    }

                    $(".zoom-btn").tooltip({delay: {show: 50}, placement: 'top', trigger: 'hover'});
                    $("#download-data").tooltip({delay: {show: 50}, placement: 'top', trigger: 'hover'});
                    
                    if (!{{ is_superfamily_job }}) {
                        $("#advanced-search-input-container").show();
                    }
                    if (!{{ is_direct_job }}) {
                        $("#start-info").show();
                    } else {
                        ui.initialDirectJobLoad();
                        $("#show-uniprot-ids").click(function(e) {
                            $("#uniprot-ids-modal").modal("show");
                        });
                    }
                    
                    if ({{ is_blast }}) {
                        $("#show-blast-sequence").click(function(e) { $("#blast-sequence-modal").modal("show"); });
                    }
                    
                } else {
                    //TODO: nicer message
                    alert("Your browser is not supported.");
                }
                
                if ({{ has_unmatched_ids }}) {
                    $("#show-unmatched-ids").click(function(e) {
                        $("#unmatched-ids-modal").modal("show");
                    });
                }
                
                $("#help-modal-button").click(function(e) {
                    $("#help-modal").modal("show");
                });

                $("#info-modal-button").click(function(e) {
                    $("#info-modal").modal("show");
                });

                $(".tooltip-text").tooltip({delay: {show: 50}, placement: 'top', trigger: 'hover'});
                $('[data-toggle="tooltip"]').tooltip();

                $("#save-canvas-button").click(function(e) {
                    var svg = $("#arrow-canvas")[0].outerHTML;
                    var legendSvg = filterUi.getLegendSvg();
                    var combinedSvg = `
                        <svg xmlns="http://www.w3.org/2000/svg">
                            ${svg}
                            ${legendSvg}
                        </svg>
                    `;
                    var blob = new Blob([combinedSvg], {type: "image/svg+xml;charset=utf-8"});
                    var url = URL.createObjectURL(blob);

                    var downloadLink = document.createElement("a");
                    downloadLink.href = url;
                    downloadLink.download = "diagram.svg";

                    document.body.appendChild(downloadLink);
                    downloadLink.click();
                    document.body.removeChild(downloadLink);

                    URL.revokeObjectURL(url);
                });

                $("#advanced-search-cluster-button").click(function() {
                    query = $("#advanced-search-input").val();
                });

                $("#window-size").change(function() {
                    windowSize = $(this).val();
                });

                $('input[name="display-id-type"]').change(function() {
                    idTypeButtonClicked = true;
                    console.log("in the check for button click, $(this).val() is", $(this).val());
                    if (idKeyQueryString.includes("id-type")) {
                        idKeyQueryString = idKeyQueryString.replace(/id-type=[^&]+/, "id-type=" + $(this).val());
                    } else {
                        idKeyQueryString += "&id-type=" + $(this).val();
                    }
                    console.log("Changed idKeyQueryString to", idKeyQueryString);
                });

                var diagramCountSpan = document.getElementById('diagrams-displayed-count');
                var observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.type === 'childList') {
                            diagramsDisplayed = parseInt(diagramCountSpan.textContent, 10);
                            console.log("Diagrams displayed updated:", diagramsDisplayed);
                        }
                    });
                });

                observer.observe(diagramCountSpan, { childList: true });

                $("#export-gene-graphics-button").click(async function(e) {
                    e.preventDefault();
                    try {
                        console.log("idKeyQueryString is now", idKeyQueryString);
                        const data = await fetch('{{ widget_asset_url.split("widgets/")[0] + "widgets/data" }}?' + idKeyQueryString + '&window=' + windowSize + '&query=' + query + '&stats=1');
                        const stats = await data.json();
                        indexRange = stats["stats"]["index_range"];
                        hasUniref = stats["stats"]["has_uniref"]
                        // limit it to only the diagrams displayed on the screen
                        if (indexRange[0][1] - indexRange[0][0] > diagramsDisplayed) {
                            indexRange[0][1] = indexRange[0][0] + diagramsDisplayed;
                        }

                        // use has_uniref to set the id_type, unless the button has been clicked, in which case it should already be set correctly
                        if (!idTypeButtonClicked && (hasUniref == 90 || hasUniref == 50)) {
                            if (idKeyQueryString.includes("id-type")) {
                                idKeyQueryString = idKeyQueryString.replace(/id-type=[^&]+/, "id-type=" + hasUniref);
                            } else {
                                idKeyQueryString += "&id-type=" + hasUniref;
                            }
                        }
                        const response2 = await fetch('{{ widget_asset_url.split("widgets/")[0] + "widgets/data" }}?' + idKeyQueryString + '&window=' + windowSize + '&scale-factor=7.5&range=' + indexRange[0][0] + '-' + indexRange[0][1]);
                        const data2 = await response2.json();

                        let output = "Genome\tID\tStart\tStop\tSize (nt)\tStrand\tFunction\tFC\tSS\tSet\n";

                        data2.data.forEach(function(row) {
                            const A = row.attributes;
                            const org = A.organism;
                            const num = A.num;
                            let queryProcessed = false;

                            row.neighbors.forEach(function(N) {
                                if (N.num > num && !queryProcessed) {
                                    queryProcessed = true;
                                    output += getLine(org, A);
                                }
                                output += getLine(org, N);
                            });
                        });

                        const blob = new Blob([output], {type: "text/tab-separated-values;charset=utf-8"});
                        const url = URL.createObjectURL(blob);
                        const downloadLink = document.createElement("a");
                        downloadLink.href = url;
                        downloadLink.download = "{{ gene_graphics_file_name }}_gene_graphics.tsv";

                        document.body.appendChild(downloadLink);
                        downloadLink.click();
                        document.body.removeChild(downloadLink);

                        URL.revokeObjectURL(url);

                    } catch (error) {
                        console.error('Error:', error);
                    }
                });

                function getLine(organism, data) {
                    if (!data.accession) {
                        return "";
                    }
                    
                    let family = Array.isArray(data.family_desc) ? data.family_desc.join("; ") : "";
                    if (!family) {
                        family = "none";
                    }

                    let ipro = "";
                    // added additional condition to check if the family_desc is not "Query without family"
                    if (Array.isArray(data.ipro_family)) {
                        ipro = data.ipro_family.filter(item => item !== "none").join("; ");
                        if (ipro) {
                            ipro = "; InterPro=" + ipro;
                        }
                    }

                    let line = [
                        organism,
                        data.accession,
                        Math.round(data.start / 3),
                        Math.round(data.stop / 3),
                        data.seq_len,
                        data.direction === "complement" ? "-" : "+",
                        family + ipro,
                        "",
                        "",
                        ""
                    ].join("\t") + "\n";

                    return line;
                }
            });

            function showAlertMsg() {
                // Get the snackbar DIV
                var x = document.getElementById("alert-msg");
            
                // Add the "show" class to DIV
                x.className = "show";
            
                // After 3 seconds, remove the show class from DIV
                setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);

                alert("Unable to retrieve the selected diagrams: probably because too many were selected.");
            }

            function downloadUnmatchedIds(unmatchedIds, downloadName) {
                var content = unmatchedIds.join("\n");
                var blob = new Blob([content], { type: "text/plain" });
                var url = URL.createObjectURL(blob);
                var link = document.createElement("a");
                link.href = url;
                link.download = downloadName + "_Unmatched_IDs.txt";
                link.click();
            }

            function downloadBlastSeq(blastSeq, downloadName) {
                var blob = new Blob([blastSeq], { type: "text/plain" });
                var url = URL.createObjectURL(blob);
                var link = document.createElement("a");
                link.href = url;
                link.download = downloadName + "_BLAST_Sequence.txt";
                link.click();
            }

            function downloadUniProtIds(uniProtIds, downloadName) {
                var blob = new Blob([uniProtIds], { type: "text/plain" });
                var url = URL.createObjectURL(blob);
                var link = document.createElement("a");
                link.href = url;
                link.download = downloadName + "_UniProt_IDs.txt";
                link.click();
            }
        </script>

        <div id="start-info">
            <div><i class="fas fa-arrow-left" aria-hidden="true"></i></div>
            <div>Start by entering a cluster number</div>
        </div>
        <div id="download-forms" style="display:none;">
        </div>
        <div id="info-popup" class="info-popup hidden">
            <div id="copy-info"><i class="far fa-copy"></i></div>
            <div id="info-popup-id">UniProt ID: <a href="https://www.uniprot.org/uniprot" target="_blank"><span class="popup-id"></span></a></div>
            <div id="info-popup-desc">Description: <span class="popup-pfam"></span></div>
            <div id="info-popup-sptr">Annotation Status: <span class="popup-pfam"></span></div>
            <div class="info-popup-group">
                <div class="info-hdr">Pfam</div>
                <div id="info-popup-fam"><span class="popup-pfam"></span></div>
                <div id="info-popup-fam-desc"><span class="popup-pfam"></span></div>
            </div>
            <div class="info-popup-group" >
                <div class="info-hdr">InterPro</div>
                <div id="info-popup-ipro-fam"><span class="popup-pfam"></span></div>
                <div id="info-popup-ipro-fam-desc"><span class="popup-pfam"></span></div>
            </div>
            <!--    <div id="info-popup-coords">Coordinates: <span class="popup-pfam"></span></div>-->
            <div id="info-popup-seqlen" class="info-popup-group">Sequence Length: <span class="popup-pfam"></span></div>
            <!--    <div id="info-popup-dir">Direction: <span class="popup-pfam"></span></div>-->
            <!--    <div id="info-popup-num">Gene Index: <span class="popup-pfam"></span></div>-->
        </div>
        
        {% if is_direct_job == "true" %}
            <div id="uniprot-ids-modal" class="modal fade" tabindex="-1" role="dialog">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                            <h4 class="modal-title">UniProt IDs Identified</h4>
                        </div>
                        <div class="modal-body" id="uniprot-ids">
                            <table border="0">
                                <thead>
                                    <th width="120px">UniProt ID</th>
                                    <th>Query ID</th>
                                </thead>
                                <tbody>
                                    {{ uniprot_ids_modal_text }}
                                </tbody>
                            </table>
                        </div>
                        <div class="modal-footer">
                            {% set uniprot_ids_download_text_js = uniprot_ids_download_text | replace("\n", "\\n") %}
                            <button type="button" class="btn btn-default" id="save-uniprot-ids-btn" onclick="downloadUniProtIds('{{ uniprot_ids_download_text_js }}', '{{ gnn_download_name }}')">Save to File</button>
                                                        <!--                            onclick='saveDataFn("30093__UniProt_IDs.txt", "uniprot-ids")'>Save to File</button>-->
                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        </div>
                    </div><!-- /.modal-content -->
                </div><!-- /.modal-dialog -->
            </div>

            <div id="unmatched-ids-modal" class="modal fade" tabindex="-1" role="dialog">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                            <h4 class="modal-title">IDs Detected Without UniProt Match</h4>
                        </div>
                        <div class="modal-body" id="unmatched-ids">{{ unmatched_id_modal_text }}</div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" id="save-unmatched-ids-btn" onclick="downloadUnmatchedIds({{ unmatched_ids }}, '{{ gnn_download_name }}')">Save to File</button>
                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        </div>
                    </div><!-- /.modal-content -->
                </div><!-- /.modal-dialog -->
            </div>
            {% if is_blast == "true" %}
                {<div id="blast-sequence-modal" class="modal fade" tabindex="-1" role="dialog">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                <h4 class="modal-title">Sequence Used in BLAST</h4>
                            </div>
                            <div class="modal-body" id="blast-sequence">
                                {{ blast_seq }}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-default" id="save-blast-seq-btn" onclick="downloadBlastSeq('{{ blast_seq }}', '{{ gnn_download_name }}')">Save to File</button>
                                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                            </div>
                        </div><!-- /.modal-content -->
                    </div><!-- /.modal-dialog -->
                </div>}
            {% endif %}
        {% endif %}

        <div id="help-modal" class="modal fade" tabindex="-1" role="dialog">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title">Tips for Exploring</h4>
                    </div>
                    <div class="modal-body">
                        <p>
                        <div><b>Interactive Filtering</b></div>
                        The mouse can be used to select families to filter.  To
                        do this, press and hold the Ctrl key on the keyboard
                        and click on a protein.  All of the PFam families that
                        are associated with the protein will be highlighted.
                        </p>
                        <p>
                        <div><b>Viewing Metadata</b></div>
                        Moving the mouse over a specific protein will show a
                        popup box containing metadata.  As soon as the mouse is
                        moved away from the protein, the box disappears.  To
                        keep the box open, click on the protein, and the box
                        will remain visible until the mouse is moved over a
                        different protein.
                        </p>
                        <p>
                        <div><b>Copying Metadata</b></div>
                        Clicking the copy <i class="far fa-copy"></i> icon when
                        the metadata popup box is visible will copy the
                        metadata to the clipboard.  This information can be
                        pasted into another document for further use.
                        </p>
                        <p>
                        <div><b>Direct Link to UniProt Data</b></div>
                        The UniProt ID in the metadata popup box is a link that
                        can be used to access the UniProt website for the given protein.
                        </p>
                        <p>
                        <div><b>Changing the Window (Scale)</b></div>
                        By default a maximum of 40 kbp are shown.  This window
                        scale factor can be increased <i class="fas fa-search-minus"></i> or
                        decreased <i class="fas fa-search-plus"
                        title="1.125x"></i> by using the zoom buttons.  All
                        visible diagrams wil be reloaded when using the zoom
                        buttons.
                        </p>
                        <p>
                        <div><b>Changing the Window (Gene)</b></div>
                        The GND explorer can display from 1 to 20 genes on
                        either side of the query gene (center, red).  This can be
                        changed by clicking the "genes" drop down menu in the
                        Genome Window section, and clicking the Apply button.
                        </p>
                        <p>
                        <div><b>Updating the Filter Legend</b></div>
                        Selecting a family filter makes that family, along with its
                        assigned color, appear in a legend box below the "Clear Filter"
                        button.  Individual families can be removed from the legend
                        by moving the mouse over the color box and pressing the X
                        button that appears in the color box.  For InterPro
                        families, the color is not assigned, but the functionality
                        is the same.
                        </p>
                        <p>
                        <div><b>Data Export</b></div>
                        {% if supports_download == "true" and is_uploaded_diagram == "false" %}
                            It is possible to export a file that provides the data used to generate the diagrams.
                            The data file format is SQLite, and it can be uploaded to the EFI-GNT
                            tool and viewed again in the future via the <i>View Saved Diagrams</i>
                            option.
                            For advanced use, the file can also be opened with
                            <a href="https://sqlitebrowser.org/" target="_blank">DB Browser for SQLite</a>
                            to manually extract data.
                        {% endif %}
                        </p>
                        <p>
                        The currently displayed diagrams can be exported to the Gene Graphics
                        format and displayed using the
                        <a href="https://katlabs.cc/genegraphics/" target="_blank">Gene Graphics</a>
                        comparative genomics visualization tool.
                        </p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal-dialog -->
        </div>
        <div id="info-modal" class="modal fade" tabindex="-1" role="dialog">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title">Software Licenses and Attribution</h4>
                    </div>
                    <div class="modal-body">
                        <p>
                        This site uses <a href="https://fontawesome.com">Font Awesome 5</a> and is used by
                        Creative Commons Attribution 4.0 International
                        <a href="https://fontawesome.com/license">license</a>.
                        </p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>

